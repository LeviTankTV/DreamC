(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class h{constructor(){this.app=null,this.ws=null,this.gameState={players:{},myId:null,worldSize:7e3,worldHeight:1e3},this.worldContainer=null,this.playersContainer=null,this.minimapContainer=null,this.portalsContainer=null,this.gridGraphics=null,this.worldBorder=null,this.playerRadius=15,this.keys={},this.camera={x:0,y:0},this.gameLoopInterval=null,this.lastUpdateTime=0,this.fps=60,this.frameTime=1e3/this.fps,this.playerTexture=null,this.playerSprites={},this.portalTextures={},this.portalSprites={},this.portalAnimations={},this.authToken=localStorage.getItem("authToken"),this.username=localStorage.getItem("username"),this.zones={common:{x:0,width:1e3,color:6710886,name:"Common Zone"},uncommon:{x:1500,width:1e3,color:65280,name:"Uncommon Zone"},rare:{x:3e3,width:1e3,color:35071,name:"Rare Zone"},epic:{x:4500,width:1e3,color:16711935,name:"Epic Zone"},legendary:{x:6e3,width:1e3,color:16755200,name:"Legendary Zone"}},this.portals=[{id:"P1",x:800,y:500,zone:"common"},{id:"P2",x:1700,y:500,zone:"uncommon"},{id:"P3",x:2300,y:500,zone:"uncommon"},{id:"P4",x:3200,y:500,zone:"rare"},{id:"P5",x:3800,y:500,zone:"rare"},{id:"P6",x:4700,y:500,zone:"epic"},{id:"P7",x:5300,y:500,zone:"epic"},{id:"P8",x:6200,y:500,zone:"legendary"}]}async init(){const e=document.getElementById("loadingOverlay");e&&e.classList.remove("hidden"),await this.setupPixiApp(),this.setupControls(),this.setupAuthHandlers(),this.authToken&&this.username?(document.getElementById("authOverlay").style.display="none",document.getElementById("main-menu").style.display="flex"):(this.showAuth(),document.getElementById("main-menu").style.display="none"),console.log("Game client initialized with Pixi.js"),setTimeout(()=>{e&&(e.classList.add("hidden"),setTimeout(()=>{e.parentNode&&(e.style.display="none")},400))},1e3)}async setupPixiApp(){try{this.app=new PIXI.Application,await this.app.init({width:window.innerWidth,height:window.innerHeight,backgroundColor:0,resolution:window.devicePixelRatio||1,autoDensity:!0,antialias:!0,transparent:!0});const e=await PIXI.Assets.load("assets/bg.png"),t=new PIXI.Sprite(e);t.width=this.app.screen.width,t.height=this.app.screen.height,this.app.stage.addChild(t),document.getElementById("pixi-container").appendChild(this.app.canvas),this.playerTexture=await PIXI.Assets.load("assets/fl.png"),await this.loadPortalTextures(),this.worldContainer=new PIXI.Container,this.playersContainer=new PIXI.Container,this.minimapContainer=new PIXI.Container,this.portalsContainer=new PIXI.Container,this.app.stage.addChild(this.worldContainer),this.worldContainer.addChild(this.portalsContainer),this.worldContainer.addChild(this.playersContainer),this.drawFixedGrid(),this.setupMinimap(),this.createPortals(),window.addEventListener("resize",()=>this.resizeApp()),console.log("PixiJS application initialized with zones and portals")}catch(e){throw console.error("Failed to initialize PixiJS:",e),e}}async loadPortalTextures(){const e=[];for(let t=1;t<=8;t++)e.push(PIXI.Assets.load(`assets/portal/Portalf${t}.png`).then(i=>{this.portalTextures[`frame${t}`]=i}));await Promise.all(e),console.log("All portal textures loaded")}createPortals(){this.portals.forEach(e=>{const t=[];for(let a=1;a<=8;a++)t.push(this.portalTextures[`frame${a}`]);const i=new PIXI.AnimatedSprite(t);i.anchor.set(.5),i.x=e.x,i.y=e.y;const n=200/Math.max(i.width,i.height);i.scale.set(n),i.animationSpeed=.3,i.play(),this.portalSprites[e.id]=i,this.portalsContainer.addChild(i);const o=new PIXI.Text(e.id,{fontFamily:"Arial",fontSize:16,fill:16777215,align:"center",stroke:0,strokeThickness:4});o.anchor.set(.5),o.y=-80,i.addChild(o)})}setupWorldVisuals(){this.worldBorderElement=document.createElement("div"),this.worldBorderElement.className="world-border",document.getElementById("game-container").appendChild(this.worldBorderElement)}drawWorldSquare(){this.worldBorder&&this.worldContainer.removeChild(this.worldBorder),this.worldBorder=new PIXI.Graphics,Object.values(this.zones).forEach(e=>{this.worldBorder.beginFill(e.color,.3),this.worldBorder.drawRect(e.x,0,e.width,this.gameState.worldHeight),this.worldBorder.endFill(),this.worldBorder.lineStyle(3,e.color,.7),this.worldBorder.drawRect(e.x,0,e.width,this.gameState.worldHeight)}),this.worldBorder.lineStyle(5,16777215,1),this.worldBorder.drawRect(0,0,this.gameState.worldWidth,this.gameState.worldHeight),this.worldContainer.addChildAt(this.worldBorder,0),this.drawZoneLabels()}drawZoneLabels(){this.zoneLabels&&this.zoneLabels.forEach(e=>this.worldContainer.removeChild(e)),this.zoneLabels=[],Object.values(this.zones).forEach(e=>{const t=new PIXI.Text(e.name,{fontFamily:"Arial",fontSize:24,fill:16777215,align:"center",stroke:0,strokeThickness:4});t.anchor.set(.5),t.x=e.x+e.width/2,t.y=50,this.worldContainer.addChild(t),this.zoneLabels.push(t)})}drawFixedGrid(){this.fixedGrid&&this.app.stage.removeChild(this.fixedGrid),this.fixedGrid=new PIXI.Graphics,this.fixedGrid.lineStyle(1,4473924,.3);const e=50,t=this.app.screen.width,i=this.app.screen.height;for(let s=-t;s<=t*2;s+=e)this.fixedGrid.moveTo(s,-i),this.fixedGrid.lineTo(s,i*2);for(let s=-i;s<=i*2;s+=e)this.fixedGrid.moveTo(-t,s),this.fixedGrid.lineTo(t*2,s);this.app.stage.addChild(this.fixedGrid)}drawPlayers(){const e=new Set;Object.values(this.gameState.players).forEach(t=>{if(t.x<0||t.x>this.gameState.worldSize||t.y<0||t.y>this.gameState.worldHeight)return;const i=t.id;e.add(i);let s=this.playerSprites[i];if(!s){s=new PIXI.Sprite(this.playerTexture),s.anchor.set(.5);const a=this.playerTexture.width,l=this.playerRadius*2/a;s.scale.set(l),this.playerSprites[i]=s,this.playersContainer.addChild(s)}s.x=t.x,s.y=t.y;let n=s.getChildByName("playerText");const o=t.username||t.id.substring(0,8);if(n?n.text=o:(n=new PIXI.Text(o,{fontFamily:"Arial",fontSize:12,fill:16777215,align:"center",stroke:0,strokeThickness:3}),n.anchor.set(.5),n.name="playerText",n.y=-25,s.addChild(n)),t.id===this.gameState.myId){let a=s.getChildByName("highlight");a||(a=new PIXI.Graphics,a.name="highlight",a.lineStyle(3,65280),a.drawCircle(0,0,s.width/2),s.addChildAt(a,0))}else{s.tint=16777215;const a=s.getChildByName("highlight");a&&s.removeChild(a)}}),Object.keys(this.playerSprites).forEach(t=>{if(!e.has(t)){const i=this.playerSprites[t];this.playersContainer.removeChild(i),delete this.playerSprites[t]}})}drawMinimap(e){for(;this.minimapContainer.children.length>1;)this.minimapContainer.removeChildAt(1);const t=120,i=t/this.gameState.worldSize,s=t/this.gameState.worldHeight;Object.values(this.zones).forEach(n=>{const o=new PIXI.Graphics;o.beginFill(n.color,.5),o.drawRect(n.x*i,0,n.width*i,this.gameState.worldHeight*s),o.endFill(),this.minimapContainer.addChild(o)}),this.portals.forEach(n=>{const o=n.x*i,a=n.y*s,r=new PIXI.Graphics;r.beginFill(16711935),r.drawCircle(o,a,2),r.endFill(),this.minimapContainer.addChild(r)}),Object.values(this.gameState.players).forEach(n=>{if(n.x>=0&&n.x<=this.gameState.worldSize&&n.y>=0&&n.y<=this.gameState.worldHeight){const o=n.x*i,a=n.y*s,r=n.id===this.gameState.myId?3:2,l=new PIXI.Graphics;n.id===this.gameState.myId?l.beginFill(65280):l.beginFill(this.hexColor(n.color)||5025616),l.drawCircle(o,a,r),l.endFill(),this.minimapContainer.addChild(l)}})}setupMinimap(){this.minimapContainer.x=10,this.minimapContainer.y=10;const i=new PIXI.Graphics;i.beginFill(657946,.8),i.lineStyle(2,0),i.drawRect(0,0,120,120),i.endFill(),this.minimapContainer.addChild(i),this.app.stage.addChild(this.minimapContainer)}resizeApp(){this.app.renderer.resize(window.innerWidth,window.innerHeight)}setupAuthHandlers(){const e=document.getElementById("loginBtn"),t=document.getElementById("registerBtn"),i=document.getElementById("passwordInput"),s=document.getElementById("enterGame");e&&e.addEventListener("click",()=>this.login()),t&&t.addEventListener("click",()=>this.register()),i&&i.addEventListener("keypress",n=>{n.key==="Enter"&&this.login()}),s&&s.addEventListener("click",()=>this.enterGame())}async login(){const e=document.getElementById("usernameInput").value,t=document.getElementById("passwordInput").value;if(!e||!t){this.showAuthMessage("Введите логин и пароль");return}try{const s=await(await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e,password:t})})).json();s.success?(this.authToken=s.user_id,this.username=e,localStorage.setItem("authToken",this.authToken),localStorage.setItem("username",this.username),this.hideAuth()):this.showAuthMessage("Ошибка входа: "+s.message)}catch(i){this.showAuthMessage("Ошибка соединения: "+i.message)}}async register(){const e=document.getElementById("usernameInput").value,t=document.getElementById("passwordInput").value;if(!e||!t){this.showAuthMessage("Введите логин и пароль");return}try{const s=await(await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e,password:t})})).json();s.success?(this.showAuthMessage("Регистрация успешна! Теперь войдите."),document.getElementById("passwordInput").value=""):this.showAuthMessage("Ошибка регистрации: "+s.message)}catch(i){this.showAuthMessage("Ошибка соединения: "+i.message)}}showAuthMessage(e){document.getElementById("authMessage").textContent=e}startGameLoop(){this.stopGameLoop(),this.gameLoopInterval=setInterval(()=>{this.gameLoop()},this.frameTime),this.movementInterval=setInterval(()=>{this.handleMovement()},1e3/120)}stopGameLoop(){this.gameLoopInterval&&(clearInterval(this.gameLoopInterval),this.gameLoopInterval=null),this.movementInterval&&(clearInterval(this.movementInterval),this.movementInterval=null)}setupControls(){document.addEventListener("keydown",e=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","w","a","s","d","ц","ф","ы","в"].includes(e.key)&&e.preventDefault(),this.keys[e.key.toLowerCase()]=!0}),document.addEventListener("keyup",e=>{this.keys[e.key.toLowerCase()]=!1}),window.addEventListener("blur",()=>{this.keys={}})}enterGame(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){console.log("Already connected to game server");return}if(!this.authToken){this.showAuth();return}document.getElementById("main-menu").style.display="none",document.getElementById("game-container").style.display="block",this.startGameLoop(),this.setupWorldVisuals();const e=`ws://localhost:8080/ws?token=${this.authToken}`;this.ws=new WebSocket(e),this.ws.onmessage=t=>{try{const i=JSON.parse(t.data);if(i.type==="error"){i.message.includes("auth")&&this.handleAuthError(),alert("Connection rejected: "+i.message),this.ws.close();return}this.handleGameMessage(i)}catch(i){console.error("Error parsing game message:",i)}},this.ws.onopen=()=>{console.log("Connected to game server");const t=document.querySelector(".connection-status");t&&(t.textContent="Connected",t.className="connection-status connected")},this.ws.onclose=()=>{console.log("Disconnected from game server");const t=document.querySelector(".connection-status");t&&(t.textContent="Disconnected",t.className="connection-status disconnected"),document.getElementById("main-menu").style.display="flex",document.getElementById("game-container").style.display="none",this.hideDebugInfo(),this.keepAliveInterval&&(clearInterval(this.keepAliveInterval),this.keepAliveInterval=null)},this.ws.onerror=t=>{console.error("WebSocket error:",t);const i=document.querySelector(".connection-status");i&&(i.textContent="Connection Error",i.className="connection-status disconnected")},this.keepAliveInterval=setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"ping"}))},3e4)}handleAuthError(){localStorage.removeItem("authToken"),localStorage.removeItem("username"),this.authToken=null,this.username=null,this.showAuth(),document.getElementById("main-menu").style.display="none",document.getElementById("game-container").style.display="none",this.hideDebugInfo(),this.showAuthMessage("Ошибка аутентификации. Войдите снова.")}showAuth(){document.getElementById("authOverlay").style.display="flex",document.getElementById("main-menu").style.display="none"}hideAuth(){document.getElementById("authOverlay").style.display="none",document.getElementById("main-menu").style.display="flex"}handleGameMessage(e){switch(e.type){case"state":this.gameState.players=e.players,this.gameState.myId=e.yourId,this.gameState.worldWidth=e.worldWidth||7e3,this.gameState.worldHeight=e.worldHeight||1e3,e.yourZone&&this.updateZoneDisplay(e.yourZone),this.showDebugInfo(),document.getElementById("enterGame").style.display="none",this.updateUI();break;case"pong":break;case"portal_teleport":this.handlePortalTeleport(e.data);break}}updateZoneDisplay(e){const t=document.querySelector(".zone-indicator");if(!t)return;const i={common:"Common Zone",uncommon:"Uncommon Zone",rare:"Rare Zone",epic:"Epic Zone",legendary:"Legendary Zone"};t.textContent=i[e]||"Unknown Zone";const s={common:"#666666",uncommon:"#00FF00",rare:"#0088FF",epic:"#FF00FF",legendary:"#FFAA00"};t.style.backgroundColor=s[e]||"rgba(0, 0, 0, 0.8)"}handlePortalTeleport(e){const{fromPortal:t,toPortal:i,cooldown:s,toZone:n}=e;n&&this.updateZoneDisplay(n),this.showPortalNotification(`Teleported from ${t} to ${i}! Cooldown: ${s}s`),console.log(`Portal teleport: ${t} -> ${i}, cooldown: ${s}s`)}showPortalNotification(e){let t=document.getElementById("portal-notification");t||(t=document.createElement("div"),t.id="portal-notification",t.style.cssText=`
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        `,document.body.appendChild(t)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}showDebugInfo(){document.getElementById("debug-info").style.display="block"}hideDebugInfo(){document.getElementById("debug-info").style.display="none"}updateUI(){const e=this.gameState.players[this.gameState.myId];e&&(document.getElementById("coordinates").textContent=`Your coordinates: ${Math.round(e.x)}, ${Math.round(e.y)}`,document.getElementById("playerCount").textContent=Object.keys(this.gameState.players).length,this.username&&(document.getElementById("playerId").textContent=this.username))}handleMovement(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN||!this.gameState.myId)return;let e=0,t=0;const i=5;(this.keys.arrowup||this.keys.w||this.keys.ц)&&(t=-i),(this.keys.arrowdown||this.keys.s||this.keys.ы)&&(t=i),(this.keys.arrowleft||this.keys.a||this.keys.ф)&&(e=-i),(this.keys.arrowright||this.keys.d||this.keys.в)&&(e=i),e!==0&&t!==0&&(e*=.707,t*=.707),(e!==0||t!==0)&&this.ws.send(JSON.stringify({type:"move",data:{dx:e,dy:t}}))}gameLoop(){const e=Date.now();e-this.lastUpdateTime<this.frameTime||(this.lastUpdateTime=e,this.drawWorld())}drawWorld(){const e=this.gameState.players[this.gameState.myId];e&&(this.camera.x=-e.x+this.app.screen.width/2,this.camera.y=-e.y+this.app.screen.height/2,this.worldContainer.x=this.camera.x,this.worldContainer.y=this.camera.y,this.drawWorldSquare(),this.drawPlayers(),this.drawMinimap(e))}hexColor(e){return e?e.startsWith("#")?parseInt(e.substring(1),16):{red:16711680,green:65280,blue:255,yellow:16776960,purple:16711935,cyan:65535,orange:16753920}[e.toLowerCase()]||5025616:null}destroy(){this.stopGameLoop(),this.keepAliveInterval&&clearInterval(this.keepAliveInterval),this.ws&&this.ws.close(),this.app&&this.app.destroy(!0)}}window.addEventListener("load",async()=>{window.gameClient=new h,await window.gameClient.init()});window.addEventListener("beforeunload",()=>{window.gameClient&&window.gameClient.destroy()});
